"""
MangoHud Config Manager.

Temporarily replaces the default MangoHud config for benchmarking.
Ensures cleanup even if no original config existed.
"""

import shutil
from pathlib import Path
from typing import Optional


class MangoHudConfigManager:
    """Manages MangoHud configuration for benchmarking."""

    def __init__(self):
        self.config_dir = Path.home() / ".config" / "MangoHud"
        self.config_file = self.config_dir / "MangoHud.conf"
        self.backup_file = self.config_dir / "MangoHud.conf.lgb_backup"
        self.marker_file = self.config_dir / ".lgb_session_active"
        self._backup_created = False
        self._had_original_config = False

        # Auto-restore if crashed session detected
        self._auto_restore_if_needed()

    def _auto_restore_if_needed(self) -> None:
        """Restore/cleanup from a crashed session."""
        if not self.marker_file.exists():
            return

        try:
            if self.backup_file.exists():
                # User had original config - restore it
                shutil.copy2(self.backup_file, self.config_file)
                self.backup_file.unlink()
            else:
                # User had no config - delete our benchmark config
                if self.config_file.exists():
                    self.config_file.unlink()
            self.marker_file.unlink()
        except Exception:
            pass

    def backup_config(self) -> bool:
        """Backup the current MangoHud config."""
        # Ensure config directory exists
        self.config_dir.mkdir(parents=True, exist_ok=True)

        # Create session marker for crash recovery
        try:
            self.marker_file.touch()
        except Exception:
            pass

        if self.config_file.exists():
            try:
                shutil.copy2(self.config_file, self.backup_file)
                self._backup_created = True
                self._had_original_config = True
                return True
            except Exception:
                return False
        else:
            # User has no config - track this so we delete ours on restore
            self._had_original_config = False
            return True

    def restore_config(self) -> bool:
        """Restore original config or keep benchmark display config."""
        try:
            if self._backup_created and self.backup_file.exists():
                # Restore original config
                shutil.copy2(self.backup_file, self.config_file)
                self.backup_file.unlink()
            elif not self._had_original_config:
                # User had no config before - keep our display config
                # This ensures HUD stays consistent after benchmark ends
                # Just remove logging-specific options
                self._write_display_only_config()

            # Remove session marker
            if self.marker_file.exists():
                self.marker_file.unlink()

            self._backup_created = False
            return True
        except Exception:
            return False

    def _write_display_only_config(self) -> None:
        """Write a display-only config (no logging) to keep HUD consistent."""
        config_lines = [
            "# MangoHud Display Config",
            "# Generated by Linux Game Benchmark",
            "",
            "### Display Settings ###",
            "legacy_layout=false",
            "position=top-left",
            "font_size=24",
            "background_alpha=0.5",
            "toggle_hud=Shift_L+F3",
            "",
            "fps",
            "frametime",
            "frame_timing",
            "gpu_stats",
            "gpu_temp",
            "gpu_power",
            "cpu_stats",
            "cpu_temp",
            "cpu_power",
            "ram",
            "vram",
        ]
        try:
            self.config_file.write_text("\n".join(config_lines))
        except Exception:
            pass

    def set_benchmark_config(
        self,
        output_folder: Path,
        show_hud: bool = True,
        log_interval: int = 0,
        manual_logging: bool = False,
        log_duration: int = 0,
        gpu_pci_dev: Optional[str] = None,
    ) -> bool:
        """
        Set MangoHud config for benchmarking.

        Args:
            output_folder: Where to save log files
            show_hud: Whether to show the HUD overlay
            log_interval: Logging interval in ms (0 = per-frame)
            manual_logging: If True, user must press Shift+F2 to start/stop recording
            log_duration: Recording duration in seconds (0 = unlimited)
            gpu_pci_dev: PCI address of GPU to monitor (e.g., "0000:03:00.0")
        """
        # Ensure config directory exists
        self.config_dir.mkdir(parents=True, exist_ok=True)

        config_lines = [
            "# MangoHud Benchmark Config",
            "# Generated by Linux Game Benchmark",
            "# Original config backed up to MangoHud.conf.lgb_backup",
            "",
            "### Logging Settings ###",
            f"output_folder={output_folder}",
            "log_versioning",
            f"log_interval={log_interval}",
        ]

        if log_duration > 0:
            config_lines.append(f"log_duration={log_duration}")

        if manual_logging:
            # User controls logging with Shift+F2
            config_lines.append("toggle_logging=Shift_L+F2")
        else:
            config_lines.append("autostart_log")

        config_lines.extend([
            "",
            "### Display Settings ###",
            "toggle_hud=Shift_L+F3",
        ])

        # GPU Selection for multi-GPU systems
        if gpu_pci_dev:
            config_lines.append(f"pci_dev={gpu_pci_dev}")

        if show_hud:
            config_lines.extend([
                "legacy_layout=false",
                "position=top-left",
                "font_size=24",
                "background_alpha=0.5",
                "",
                "fps",
                "frametime",
                "frame_timing",
                "gpu_stats",
                "gpu_temp",
                "gpu_power",
                "cpu_stats",
                "cpu_temp",
                "cpu_power",
                "ram",
                "vram",
            ])
        else:
            config_lines.append("no_display")

        # Log EVERYTHING MangoHud can provide
        config_lines.extend([
            "",
            "### Metrics to Log - MAXIMUM ###",
            "fps",
            "frametime",
            "frame_count",
            "",
            "# CPU - All",
            "cpu_stats",
            "cpu_temp",
            "cpu_power",
            "cpu_mhz",
            "core_load",
            "",
            "# GPU - All",
            "gpu_stats",
            "gpu_temp",
            "gpu_junction_temp",
            "gpu_mem_temp",
            "gpu_power",
            "gpu_core_clock",
            "gpu_mem_clock",
            "gpu_fan",
            "gpu_voltage",
            "throttling_status",
            "",
            "# Memory - All",
            "ram",
            "vram",
            "swap",
            "procmem",
            "procmem_shared",
            "procmem_virt",
            "",
            "# System - All",
            "resolution",
            "wine",
            "vulkan_driver",
            "engine_version",
            "io_read",
            "io_write",
            "network",
            "",
            "# Battery/Laptop - All",
            "battery",
            "battery_watt",
            "battery_time",
            "device_battery",
        ])

        try:
            self.config_file.write_text("\n".join(config_lines))
            return True
        except Exception:
            return False


def setup_benchmark_logging(output_folder: Path, show_hud: bool = True) -> MangoHudConfigManager:
    """
    Setup MangoHud for benchmark logging.

    Args:
        output_folder: Where to save logs
        show_hud: Whether to show overlay

    Returns:
        ConfigManager instance (call restore_config() when done)
    """
    manager = MangoHudConfigManager()
    manager.backup_config()
    manager.set_benchmark_config(output_folder, show_hud)
    return manager
